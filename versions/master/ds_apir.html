<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>Python User Functions &mdash; Trusted Analytics Platform 0.6.0 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="R_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="R_static/css/spc-extend.css">
    <link rel="stylesheet" href="R_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="R_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="R_static/jquery.js"></script>
    <script type="text/javascript" src="R_static/underscore.js"></script>
    <script type="text/javascript" src="R_static/doctools.js"></script>
    <script type="text/javascript" src="R_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="genindex.html" >
    <link rel="top" title="Trusted Analytics Platform 0.6.0 documentation" href="index.html" >
    <link rel="up" title="Process Flow Examples" href="ds_dflw.html" >
    <link rel="next" title="Naive Bayes" href="ds_naive_bayes.html" >
    <link rel="prev" title="Process Flow Examples" href="ds_dflw.html" > 
  </head>
  <body>

  <div class="container">
    <div class="header">
    </div>
  </div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="index.html">Trusted Analytics</a></li>
	
          <li class="active"><a href="ds_over.html" >User Manual</a></li>
          <li class="active"><a href="ds_dflw.html" accesskey="U">Process Flow Examples</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="ds_dflw.html" title="Process Flow Examples"
           accesskey="P">previous</a>
      </li>
      <li class="active">
        <a href="ds_naive_bayes.html" title="Naive Bayes"
           accesskey="N">next</a>
      </li>
      <li class="active">
        <a href="genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<h3><a href="index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Technical Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="ds_over.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_over.html">Extending Trusted Analytics Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="ad_over.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest_api/v1/index.html">REST API</a></li>
</ul>
<ul class="simple">
</ul>

        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <span class="target" id="ds-apir"></span><div class="section" id="python-user-functions">
<span id="index-0"></span><h1>Python User Functions<a class="headerlink" href="#python-user-functions" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#frame-row-udf" id="id1">Frame Row <abbr title="Python User-defined Function">UDF</abbr></a><ul>
<li><a class="reference internal" href="#row-object-parameter" id="id2">Row Object Parameter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#udf-guidelines" id="id3"><abbr title="Python User-defined Function">UDF</abbr> Guidelines</a></li>
</ul>
</div>
<p>A <a class="reference internal" href="glossary.html#term-udf"><span class="xref std std-term">UDF</span></a> is a Python function written by the user on the client-side which
can execute in a distributed fashion on the cluster.
The function is serialized and copies are distributed throughout the cluster as
part of command execution.
Various API command methods accept a <abbr title="Python User-defined Function">UDF</abbr> as a parameter.
A <abbr title="Python User-defined Function">UDF</abbr> runs under the constraints of the particular command.</p>
<div class="section" id="frame-row-udf">
<h2>Frame Row <abbr title="Python User-defined Function">UDF</abbr><a class="headerlink" href="#frame-row-udf" title="Permalink to this headline">¶</a></h2>
<p>A Frame Row <abbr title="Python User-defined Function">UDF</abbr> is a <abbr title="Python User-defined Function">UDF</abbr> which operates on a single row of a frame.
The function has one parameter, a <em>row</em> object.
Here is an example of a Row <abbr title="Python User-defined Function">UDF</abbr> that returns True for a row where the column
named “score” has a value greater than zero:</p>
<div class="code highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">my_custom_row_func</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
<p>This function would be useful in a Frame filter command, which filters a data
frame keeping only those rows which meet certain criteria, &#8211; in this case,
only rows with scores greater than zero:</p>
<div class="code highlight-python"><div class="highlight"><pre>&gt;&gt;&gt; my_csv = CsvFile(“results.txt”, [(‘test’, str), (‘score’, int32)])
&gt;&gt;&gt; my_frame = Frame(my_csv)
&gt;&gt;&gt; my_frame.filter(my_custom_row_func)
</pre></div>
</div>
<p>The filter command iterates over every row in the frame and
evaluates the user-defined function on each one and keeps only those rows which
evaluate to True.</p>
<div class="section" id="row-object-parameter">
<h3>Row Object Parameter<a class="headerlink" href="#row-object-parameter" title="Permalink to this headline">¶</a></h3>
<p>The Row object is a read-only dictionary-like structure which contains the cell
values for a particular row.
The values are accessible using the column name, with typical Python square
bracket lookup, as shown in the example above.
The value of cell in column &#8216;score&#8217; is accessed like this:</p>
<div class="code highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="p">[</span><span class="s">&#39;score&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The cell values may also be accessed using <em>dot-member</em> notation.
Here is an equivalent row function:</p>
<div class="code highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">my_custom_row_func2</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
<p>The <em>dot-member</em> notation is provided for convenience (it follows the pandas
DataFrame technique) and only works for columns whose names are legal Python
variable names (it does not start with a number and is composed of alphanumeric
characters and the underscore character).
Columns whose names do not meet this criteria must be referenced using square
brackets with strings.</p>
<p>New values must be added to a frame using the Frame’s add_columns method.</p>
<p>The <em>row</em> object supports a few dictionary-like methods:</p>
<ul class="simple">
<li><em>keys()</em> &#8211; returns a list of column names</li>
<li><em>values()</em> &#8211; returns a list of column values</li>
<li><em>items()</em> &#8211; returns a list of (key, value) tuples</li>
<li><em>types()</em> &#8211; returns a list of column types</li>
</ul>
<p>These methods all produce lists in the same order, in other words, it is safe
to correlate their indices.</p>
<p>Also, iterating on the row object is the equivalent of iterating on items().
For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">row_sum</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="sd">    sums the values in the row, except for column &quot;name&quot;</span>
<span class="gp">... </span><span class="sd">    &quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="k">try</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
<span class="gp">... </span>           <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;name&#39;</span><span class="p">:</span>
<span class="gp">... </span>               <span class="nb">sum</span> <span class="o">+=</span> <span class="n">v</span>
<span class="gp">... </span>       <span class="k">return</span> <span class="n">s</span>
<span class="gp">... </span>   <span class="k">except</span><span class="p">:</span>
<span class="gp">... </span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">frame</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span><span class="n">row_sum</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;sum&#39;</span><span class="p">,</span> <span class="n">int32</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example is for illustration only.
There are other ways of doing this, like using a list comprehension.</p>
</div>
</div>
</div>
<div class="section" id="udf-guidelines">
<h2><abbr title="Python User-defined Function">UDF</abbr> Guidelines<a class="headerlink" href="#udf-guidelines" title="Permalink to this headline">¶</a></h2>
<p>Here are some guidelines to follow when writing a <abbr title="Python User-defined Function">UDF</abbr>:</p>
<ol class="arabic">
<li><p class="first">Error handling:
Include error handling.
If the function execution raises an exception, it will cause the entire
command to fail and possibly leave the frame or graph in an incomplete
state.
The best practice is to put all <abbr title="Python User-defined Function">UDF</abbr> functionality in a <code class="docutils literal"><span class="pre">try:</span> <span class="pre">except:</span></code>
block, where the <code class="docutils literal"><span class="pre">except:</span></code> clause returns a default value or performs a
benign side effect.
See the <code class="docutils literal"><span class="pre">row_sum</span></code> function example above, where we used a
<code class="docutils literal"><span class="pre">try:</span> <span class="pre">except:</span></code> block and produced a -1 for rows which caused errors.</p>
</li>
<li><p class="first">Dependencies:
All dependencies used in the <abbr title="Python User-defined Function">UDF</abbr> must fit into one of the following:</p>
<ol class="upperalpha simple">
<li>Be available in <strong>the same Python code file</strong> (or REPL) as the <abbr title="Python User-defined Function">UDF</abbr></li>
<li>Be available in the server&#8217;s installed Python libraries.</li>
<li>Be specified in the <code class="docutils literal"><span class="pre">udf_dependencies</span></code> list.  This is a list of
files and folders which will be sent along with the UDF to the server
when it is invoked.  This causes overhead, so use judiciously.</li>
</ol>
<div class="code highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">trustedanalytics</span> <span class="kn">as</span> <span class="nn">ta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ta</span><span class="o">.</span><span class="n">udf_dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;helper_script.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Simplicity:
Stay within the intended simple context of the given command, like a row
operation.
Do not try to call other API methods or perform fancy system operations
(which will fail due to permissions).</p>
</li>
<li><p class="first">Performance:
Be mindful of performance.
These functions execute on every row of data, in other words, many times.</p>
</li>
<li><p class="first">Printing:
Printing (to stdout, stderr, …) within the <abbr title="Python User-defined Function">UDF</abbr> will not show up in the
client REPL.
Such messages will usually end up in the server logs.
In general, avoid printing.</p>
</li>
<li><p class="first">Lambda:
Lambda syntax is valid, but discouraged:</p>
<div class="code highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">frame</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>This is legal and attractively shorter to write.
However, lambdas do not provide error handling, nor do they have a “name”
that would be useful in exception stack traces.
They cannot be tested in isolation nor have embedded documentation.
Lambdas are not very shareable.</p>
</li>
<li><p class="first">Closures:
Closures are read-only.
Any closed over variables are copied during serialization, so it is not
possible to obtain side-effects.</p>
</li>
<li><p class="first">Multiple executions:
Do not make any assumptions about how many times the function may get
executed.</p>
</li>
<li><p class="first">Parameterizing a <abbr title="Python User-defined Function">UDF</abbr>:
Parameterizing a <abbr title="Python User-defined Function">UDF</abbr> is possible using Python techniques of closures and
nesting function definitions.
For example, the Row <abbr title="Python User-defined Function">UDF</abbr> only takes a single row object parameter.
It could be useful to have a row function that takes a few other
parameters.
Let’s augment the row_sum function above to take a list of columns to
ignore:</p>
<div class="code highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">get_row_sum_func</span><span class="p">(</span><span class="n">ignore_list</span><span class="p">):</span>
<span class="gp">... </span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="sd">   returns a row function which sums the values in the row,</span>
<span class="gp">... </span><span class="sd">   except for ignored columns</span>
<span class="gp">... </span><span class="sd">   &quot;&quot;&quot;</span>
<span class="gp">... </span>   <span class="k">def</span> <span class="nf">row_sum2</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="gp">... </span>       <span class="k">try</span><span class="p">:</span>
<span class="gp">... </span>           <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">... </span>           <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
<span class="gp">... </span>               <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_list</span><span class="p">:</span>
<span class="gp">... </span>                   <span class="n">s</span> <span class="o">+=</span> <span class="n">v</span>
<span class="gp">... </span>           <span class="k">return</span> <span class="n">s</span>
<span class="gp">... </span>       <span class="k">except</span><span class="p">:</span>
<span class="gp">... </span>           <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<span class="gp">... </span>       <span class="k">return</span> <span class="n">row_sum2</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">frame</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span><span class="n">get_row_sum_func</span><span class="p">([</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;address&#39;</span><span class="p">]),</span> <span class="p">(</span><span class="s">&#39;sum&#39;</span><span class="p">,</span> <span class="n">int32</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="code docutils literal"><span class="pre">row_sum2</span></code> function closes over the <em>ignore_list</em> argument making it
available to the row function that executes on each row.</p>
</li>
</ol>
</div>
</div>


          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2015, Intel.
      </li>
      <li>
      Last updated on Feb 02, 2016.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>